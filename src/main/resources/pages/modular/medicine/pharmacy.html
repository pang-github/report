<% layout("/common/_container.html"){ %>

<div class="layui-fluid" id="app">
    <div class="layui-card-body">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 35px;">
            <legend>处方药表</legend>
        </fieldset>

        <div class="layui-row layui-col-space15 ">
            <div class="layui-col-md9 layui-col-space10">
                <div class="layui-col-md12 ">
                    <div class="layui-card layui-anim layui-anim-scale">
                        <!--                    <div class="layui-card-header">卡片面板</div>-->
                        <div class="layui-card-body">
                            {{rxdrugList.patientName}} <br>
                        </div>
                    </div>
                </div>
                <div v-for="itme in rxdrugList.drugList" class="layui-col-md3 ">
                    <div class="layui-card layui-anim layui-anim-scale">
                        <!--                    <div class="layui-card-header">卡片面板</div>-->
                        <div class="layui-card-body">
                            {{itme.drugName}} ：{{itme.drugNumber}}{{itme.drugUnit}}<br>
                        </div>
                    </div>
                </div>
            </div>


            <div class="layui-col-md3">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                    <legend>抓药记录</legend>
                    <div class="layui-form layui-form-item" pane="">
                        <label class="layui-form-label">开关-开</label>
                        <div class="layui-input-block">
                            <input type="checkbox" checked="" name="open" lay-skin="switch" lay-filter="switchTest" title="开关">
                        </div>
                    </div>
                </fieldset>

                <ul class="layui-timeline layui-anim layui-anim-up" id="recordTime">

                    <li v-for="itme in pharmacyList" class="layui-timeline-item layui-anim layui-anim-up" @click="getTio(itme.recordId)">
                        <i class="layui-icon layui-timeline-axis"></i>
                        <div class="layui-timeline-content layui-text">
                            <h3 class="layui-timeline-title">{{itme.createTime}}</h3>
                            <div class="layui-card">
                                <div v-if="itme.stateType=='0'" class="layui-card-header">
                                    <span  class="layui-badge-dot" style="right:5px;"></span>
                                    需要配置</div>
                                <div v-if="itme.stateType=='1'" class="layui-card-header">
                                    <span  class="layui-badge-dot layui-bg-green" style="right:5px;"></span>
                                    配置完成</div>
                                <div class="layui-card-body">
                                    药物信息
                                </div>
                            </div>
                        </div>
                    </li>
<!--                    <li class="layui-timeline-item">-->
<!--                        <i class="layui-icon layui-anim layui-anim-rotate layui-anim-loop layui-timeline-axis"></i>-->
<!--                        <div class="layui-timeline-content layui-text">-->
<!--                            <div class="layui-timeline-title">过去</div>-->
<!--                        </div>-->
<!--                    </li>-->
                </ul>
            </div>

            <!--            <div class="layui-col-md12">-->
            <!--                <div class="layui-card">-->
            <!--                    <div class="layui-card-header">标题</div>-->
            <!--                    <div class="layui-card-body">-->
            <!--                        内容-->
            <!--                    </div>-->
            <!--                </div>-->
            <!--            </div>-->
        </div>
    </div>
</div>

<script>
    var vm = new Vue({
        el: '#app',
        data: {
            msg: 'Hello World!',
            info:{},
            pharmacyList:'',
            addTime:'',
            rxdrugList:'',
        },
        computed:{
        },
        methods: {
            getDetail:async function(id){
                vm.info = await request.fetch("getRxdrugDetail",{id:id});
                form.val('rxdrugForm', vm.info);
            },
            back:function(){
                location.href = 'rxdrug_list';
            },
            getDic:async function(){
                var data = {
                }
                var res = await api.getDictList(data);
            },
            getTio:function(id){
                var data= {"id":id}
                request.post("/admin/clinicPharmacy/getRecordList",data).then(res=>{

                    vm.rxdrugList = res
                        // .drugList
                    console.log(res)
                })
            },

            getlist:async function(){
                request.post("/admin/clinicPharmacy/getPharmacyList").then(res=>{
                    vm.pharmacyList = res;
                })
            },
            getById:async function(id){
                request.post('/admin/clinicPharmacy/getPharmacyById',{'id':id}).then(res=>{
                    vm.addTime = res;
                    //vm.addend(res)
                    vm.pharmacyList.unshift(res)
                })
            },
            openTio:function(){
                request.post('/admin/clinicPharmacy/tioJob')
            },
            handleScroll () {
                var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
                console.log(scrollTop)
                    var offsetTop = document.querySelector('#searchBar').offsetTop
                    if (scrollTop > offsetTop) {
                        this.searchBarFixed = true
                    } else {
                        this.searchBarFixed = false
                    }
            },
        },
        mounted:async function() {

            vm = this;
            await  vm.getlist()

            var uid = parseInt(Math.random()*10000);
            var url = "ws://localhost:9876";
            var ws =new WebSocket(url);
            ws.onopen=function(res){

            }
            ws.onmessage=function (res) {
                var split = res.data.split(':')
                if(split[0]=="tips"){
                    layer.msg(res.data.split(':')[1]+'条需要配置', {
                        offset: '6px',
                });
                } if(split[0]=="id"){
                    vm.getById(split[1])
                }

            }
            ws.onclose=function(res){
                console.log("关闭")
            }

            window.addEventListener('scroll', this.handleScroll)

        },
        updated: function () {
            layui.use('form', function(){
                var form = layui.form;

                form.on('switch(switchTest)', function(data){
                    // layer.msg('开关checked：'+ (this.checked ? 'true' : 'false'), {
                    //     offset: '6px'
                    // });
                    layer.tips(this.checked ? '实时接收信息' : '关闭接收信息', data.othis)

                });
            });
            form.render();
        }
    })
</script>


<% } %>

<style>
    .layui-input-inline{
        min-width:350px !important;
    }


</style>
