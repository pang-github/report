<% layout("/common/_container.html"){ %><div class="layui-fluid" id="app">    <div class="layui-row layui-col-space15 ">            <div class="layui-col-sm12 layui-col-md9 layui-col-lg10" style="background: #FFFFFF;">                <div class="layui-card">                    <div class="layui-card-body">                <div class="layui-form toolbar">                    <div class="layui-form-item">                        <div class="layui-inline">                            <button type="button" @click="btnAdd" class="layui-btn layui-btn-danger icon-btn"><i class="layui-icon">&#xe654;</i>开始诊断</button>                        </div>                        <div class="layui-inline">                            <button type="button" @click="btnPrint" id="btnPrint" class="layui-btn layui-btn-danger icon-btn"><i class="layui-icon layui-icon-print"></i>打印病例</button>                        </div>                    </div>                </div>                <table class="layui-table" id="recordTable" lay-filter="recordTable"></table>                    </div>                </div>            </div>    </div></div><script type="text/html" id="titleTipl">    <a href="javascript:;" data-d="{{d.descript}}" οnmοuseοver="show_shopm(this)">{{d.name}}</a></script><script type="text/html" id="titleTpl">    <select name="interest" class="sel_scrq" lay-filter="aihao" style="height: 10px">        <option value="1" selected="">{{d.stateTypeName}}</option>    </select></script><script>    var initColumn =  [[        {type: 'radio'},        {field:'id',title:'',hide:true},        {field: 'stateType', title: '病历状态'},        {field:'checkTime',title:'检查时间'},        {field:'patientName',title:'患者名字'},        {field:'patientId',title:'患者id',hide:true},        {field:'examine',title:'检查',width:200},        {field:'diagnose',title:'诊断',width:200},        {field:'drugList',title:'药品详情',templet:function(d){               //'<span style="color: #c00;">'+ itme.drugName +'</span>:'+ itme.drugNumber+itme.drugUnit +'<br>'                var html = "";                var i = 0                for(let item of d.drugList){                    i++                    if(i==5){                        i=0                        html += ('<span style="color: #c00;">'+item.drugName+"</span>:"+item.drugNumber+item.drugUnit+"<br>");                    }else{                        html += ('<span style="color: #c00;">'+item.drugName+"</span>:"+item.drugNumber+item.drugUnit);                    }                }                return html;            }},        {field:'drugMoney',title:'药品总价格'},        {field:'picture',title:'检查照片',hide: true},        {field:'zycs',title:'就诊次数'},    ]];    var vm = new Vue({        el: '#app',        data: {            msg: 'Hello World!',            condition:'',            treeData:'',            treename:[],            patient:{},            patientPID:"",            patientPNAME:"",            patientSearch:"",            newtree:'',            sessionPID:'',            DictList:{},        },        watch:{            patientSearch:function (newVal,oldVal) {                var list = new Array();                for(let item of vm.treename){                        if((item.title).match(newVal)){                            var data = {                                id:item.id,                                title:item.title,                                name:item.name,                            }                            list.push(data)                        }                    }                vm.newtree = list                tree.reload('demoId', {                    data: [{                        title: '患者' //一级菜单                        ,spread: true                        ,children: vm.newtree //二级菜单                    }]                    ,click:function(obj){                        vm.patient=obj.data;                        vm.search(obj)                    }                });                },        },        methods: {            getTree:async function(){                var url = '/admin/patient/getPatientList'                /*if(!app.isEmpty(vm.tree.id)){                    url += '?patientId='+vm.tree.id                }*/                vm.treeData = await request.fetch(url);                var temp = vm.treeData;                var list = new Array();                for(let item of temp){                        var data = {                            id:item.id,                            title:item.patientName+" "+"<span style='color:#FF5722'>"+item.phoneNumber+"</span>",                            name:item.patientName                        }                    if(app.isEmpty(item.patientName)){                        var wx = ''                        var wx1 = ''                        var wxName = ''                        var wxName1 = ''                        if(item.patientSource==1){                            wx = '<span style="color:#5FB878">微信</span>'                            wx1 =" 微信"                        }                        if(app.isEmpty(item.phoneNumber)){                            wxName = '<span style="color:#5FB878">'+" "+item.patientNickname+'</span>'                            wxName1 = " "+item.patientNickname                        }                        var data = {                            id:item.id,                            title:'<span style="color:#FF5722">'+item.phoneNumber+'</span>'+wx+wxName,                            name:item.phoneNumber+wx1+wxName1                        }                    }                    list.push(data)                }                vm.treename = list            },            search:async function(obj){                var queryData = {                    patientId:obj.data.id,                };                table.reload('recordTable',{                    where: queryData, page: {                        curr: 1 //重新从第 1 页开始                    }});            },            btnAdd:function () {                var patient  = vm.patient;                var id = vm.patientPID;                if(app.isNotEmpty(patient.id)){                    location.href = '/admin/medicine/doctor?patientId='+patient.id+'&patientName='+patient.name;                }else{                    location.href = '/admin/medicine/doctor?patientId='+vm.patientPID+'&patientName='+vm.patientPNAME;                }            },            btnPrint:function(){                //打开打印页面                    var  checkStatus= table.checkStatus("recordTable");                    var item = checkStatus.data                    if(!app.isEmpty(item)){                        var src = '/admin/medicine/medicine_print?id=' + item[0].id+"&patientId="+item[0].patientId;                        // window.location.href = src;                        parent.layer.open({                            type: 2 //Page层类型                            ,title: '病例打印'                            ,area:['700px', '900px']                            ,shadeClose: true                            ,shade: 0.5 //遮罩透明度                            ,maxmin: true //允许全屏最小化                            ,content:src                            ,btn: ['打印', '取消']                            ,btnAlign: 'c'                            ,success: function(layero, index){                            }                            ,yes: function(index, layero){                                var pageIndex = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引                                //得到iframe页的窗口对象                                var iframeWin = $(layero).find("iframe")[0].contentWindow;                                iframeWin.printA4();                                //按钮【按钮一】的回调                            }                            ,btn2: function(index, layero){                                //按钮【按钮二】的回调                                //return false 开启该代码可禁止点击该按钮关闭                            }                        });                        //app.printFun(src);                    }else{                        app.error("请先选择需要打印的订单╮(╯▽╰)╭");                    }            },            tableReload:function (action) {                if(action=='reset'){ vm.condition='' };                var queryData = {                    //id:vm.condition,                    patientName:vm.condition,                    //checkTime:vm.condition,                    //patientId:vm.condition,                };                table.reload('recordTable',{                    where: queryData, page: {                        curr: 1 //重新从第 1 页开始                    }});            },            csstree:function(){                $('div [data-id="'+vm.patientPID+'"] div [class=layui-tree-txt]').css({'background-color':'#4f5655',"color":'#FFFFFF'});            },            treecss:function(){                $('div [data-id="' + vm.patientPID + '"] div [class=layui-tree-txt]').css({                    'background-color': '#FFFFFF',                    "color": '#555'                });            }        },        mounted: async function () {            vm = this;            var getid =app.getUrlParam("id")            //elem.find('.layui-tree-txt').html()            if (app.isNotEmpty(sessionStorage.getItem('PID'))) {                var PID = sessionStorage.getItem('PID').split(',')                vm.patientPID = PID[0]                vm.patientPNAME = PID[1]            }            await this.getTree();            var tree = layui.tree;            //渲染            if(app.isNotEmpty(getid)){                table.render({                    elem: '#recordTable',                    url: '/admin/record/getRecordList',                    page: true,                    height: "full-132",                    cellMinWidth: 100,                    cols: initColumn,                    where:{                        id:getid                    },                    done: function () {                        /* 防止下拉框的下拉列表被隐藏---必须设置--- */                        $(".sel_scrq").parent().css('overflow', 'visible');                    }                });            }else{            }            table.on('tool(recordTable)', function (obj) {                var event = obj.event;                var data = obj.data;                if (event == 'del') {                    app.confirm("确定删除吗?", function () {                        request.fetch("delRecord", {id: data.id}).then(res => {                            app.success("删除成功！")                            vm.tableReload();                        })                    })                } else if (event == 'edit') {                    location.href = 'record_edit?id=' + data.id;                }            });            if (app.isNotEmpty(vm.patientPID)) {                var queryData = {                    patientId: vm.patientPID,                };                var obj={                    data:{                        id: vm.patientPID,                        title: vm.patientPNAME,                        name: vm.patientPNAME                    }                }                vm.patient = obj.data;                vm.search(obj)                sessionStorage.removeItem('PID')            }            /* 跳转改变患者树的颜色*/            vm.csstree()        },        updated: function () {        }    })</script><style>    /* 使得下拉框与单元格刚好合适 */    td .layui-form-select{        margin-top: -10px;        margin-left: -15px;        margin-right: -15px;    }</style><% } %>