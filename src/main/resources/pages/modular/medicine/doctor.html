<% layout("/common/_container.html"){ %><div class="layui-fluid" id="app">    <div id="addPPP" style="display: none">        <form class="layui-form" lay-filter="patientForm" style="margin: 35px 0 30px 20%;">            <input type="hidden" name="id">            <div class="layui-form-item">                <label class="layui-form-label">患者姓名<span style="color: red;">*</span></label>                <div class="layui-input-inline">                    <input name="patientName" type="text" id="nameFome" placeholder="请输入患者姓名" class="layui-input" lay-verify="required|" />                </div>            </div>            <div class="layui-form-item">                <label class="layui-form-label">患者性别</label>                <div class="layui-input-inline">                    <input type="radio" name="patientSex" value="1" title="男" checked>                    <input type="radio" name="patientSex" value="2" title="女">                </div>            </div>            <div class="layui-form-item">                <label class="layui-form-label">患者年龄</label>                <div class="layui-input-inline">                    <input name="patientAge" type="text" placeholder="请输入患者年龄" class="layui-input" lay-verify="" />                </div>            </div>            <div class="layui-form-item">                <label class="layui-form-label">电话号码</label>                <div class="layui-input-inline">                    <input name="phoneNumber" type="text" placeholder="请输入电话号码" class="layui-input" />                </div>            </div>            <div class="layui-form-item">                <label class="layui-form-label">创建医师</label>                <div class="layui-input-inline">                    <select name="checkDoctor" lay-search  lay-verify="required">                        <option></option>                        <option v-for="item in userdata" :value="item.realName">{{item.realName}}</option>                    </select>                </div>            </div>            <!--<div class="layui-form-item">                <label class="layui-form-label">创建时间</label>                <div class="layui-input-inline">                    <input name="createTime" type="text" placeholder="请输入创建时间" class="layui-input" lay-verify="" />                </div>            </div>-->            <div class="layui-form-item" style="margin:28px 30px;">                <div class="layui-input-block">                    <button type="button" class="layui-btn" lay-filter="patientForm" lay-submit>提交</button>                </div>            </div>        </form>    </div>    <div class="layui-card" >        <div class="layui-col-md3 layui-col-sm12"  style="min-height: 10px;">            <div id="fiexdDiv" >                <div style="display: block; box-sizing:border-box;width:95%;padding: 35px;background: #FFFFFF;" >                    <blockquote class="layui-elem-quote">处方选择</blockquote>                    <div id="template" style="margin-top: 20px;">                        <div class="layui-form-item">                            <label class="layui-form-label" style="width: 40px !important;">  搜索:</label>                            <div class="layui-input-inline">                                <input type="text" placeholder="名字搜索" style="width: 200px;" class="layui-input"  v-model="search">                            </div>                        </div>                        <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">                            <ul class="layui-tab-title">                                <li class="layui-this" v-on:click="getTree('/admin/drug/getallDrug','0')">处方药</li>                                <li v-on:click="getTree('/admin/cfmb/getCfmbList','1')">处方模板</li>                            </ul>                            <div class="layui-tab-content" >                                <div style="height: 600px;overflow: scroll;">                                    <table class="layui-table"  >                                        <thead v-if="treecheck == 0">                                        <tr>                                            <th>药名</th>                                            <th>单位</th>                                            <th id="is_pay_explain" >价格(元)<i class="layui-icon layui-icon-about" style="font-size: 18px; color: #555555;"></i>  </th>                                        </tr>                                        </thead>                                        <thead v-if="treecheck == 1">                                        <tr>                                            <th>处方名</th>                                            <th>价格(元)</th>                                        </tr>                                        </thead>                                        <tbody >                                        <tr v-for="(item,index) in treeList" v-if="treecheck == 0"  v-on:click="addRight(item)">                                            <td>{{item.drugName}}</td>                                            <td>{{item.drugUnit}}</td>                                            <td v-if="item.upprice" style="color: #FF0000">{{item.upprice}}</td>                                            <td v-else >{{item.drugPrice}}</td>                                        </tr>                                        <tr v-for="(item,index) in treeList" v-if="treecheck == 1"  v-on:click="addRight(item)">                                            <td >{{item.recipeName}}</td>                                            <td >{{item.recipePrice}}</td>                                        </tr>                                        </tbody>                                    </table>                                </div>                            </div>                        </div>                    </div>                </div>            </div>        </div>        <div class="layui-col-md9 layui-col-sm10" style="background: #FFFFFF;">            <form class="layui-form" lay-filter="recordForm" style="max-width: 1000px;margin: 40px auto;">                <input type="hidden" name="id">                <input id="patientId" name="patientId"  value="${parameter.patientId}" type="text" placeholder="请输入患者id" class="layui-input layui-hide" lay-verify="" />                <table class="layui-table">                    <tbody>                    <tr>                        <td>患者名字</td>                        <td>                            <!--<input id="patientName" autocomplete="off" name="patientName"  value="${parameter.patientName}" type="text" placeholder="请输入患者名字" class="layui-input" lay-verify=""  style="position:absolute;z-index:2;width:80%;"/>                            <select type="text" id="hc_select" lay-filter="hc_select" autocomplete="off" placeholder="移交单位全称" lay-verify="required" class="layui-select" lay-search>                                <option value=""></option>                                <option v-for="item in select" value="">{{item.patientName}}</option>                            </select>-->                            <div class="layui-input-inline" style="width: 80%">                                <input type="text" name="patientName"  value="${parameter.patientName}" id="HandoverCompany" placeholder="请输入患者姓名" class="layui-input" style="position:absolute;z-index:2;width:80%;" lay-verify="required"  onkeyup="searchSelect()" autocomplete="off">                                <select type="text" id="hc_select" lay-filter="hc_select" autocomplete="off"   class="layui-select" lay-search>                                    <option value=""></option>                                    <option v-for="itme in select" :id=itme.id  :title=itme.phoneNumber  :value=itme.patientName+','+itme.phoneNumber+','+itme.patientSex+','+itme.patientAge>{{itme.patientName}}</option>                                </select>                            </div>                            <button type="button" class="layui-btn layui-btn-sm" @click="addPatient">新增患者</button>                        </td>                        <!--                                <td>就诊次数</td>-->                        <td>                            <!--                                    <input name="zycs" type="text" placeholder="请输入就诊次数"  oninput="app.clearNoNum(this)" class="layui-input" lay-verify="" />-->                        </td>                    </tr>                    <tr>                        <td>检查时间</td>                        <td>                            <input id="checkTime" name="checkTime" type="text" placeholder="请输入检查时间" class="layui-input" lay-verify="" />                        </td>                        <td>检查医生<span style="color: red;">*</span></td>                        <td>                            <select name="checkDoctor" lay-search  lay-verify="required">                                <option></option>                                <option v-for="item in userdata" :value="item.realName">{{item.realName}}</option>                            </select>                        </td>                    </tr>                    <tr>                        <td >检查</td>                        <td colspan="3">                            <textarea name="examine" type="text" placeholder="请输入检查" class="layui-textarea" lay-verify="" ></textarea>                        </td>                    </tr>                    <tr>                        <td >诊断</td>                        <td colspan="3">                            <textarea name="diagnose" type="text" placeholder="请输入诊断" class="layui-textarea" lay-verify="" ></textarea>                        </td>                    </tr>                    <input type="hidden" name="stateType" value="诊断完成">                    <!--                            <tr>-->                    <!--                                <td >病例状态</td>-->                    <!--                                <td colspan="3">-->                    <!--                                    <select name="stateType"  style="width:10px">-->                    <!--                                        <optgroup value=""></optgroup>-->                    <!--                                        <option v-for="item in dictList" :value="item.dictId">{{item.name}}</option>-->                    <!--                                        <optgroup label="在数据字典中可以添加状态"></optgroup>-->                    <!--                                    </select>-->                    <!--                                </td>-->                    <!--                            </tr>-->                    </tbody>                </table>                <fieldset class="layui-elem-field layui-field-title site-title">                    <legend>                        <a name="default">处方</a>                    </legend>                </fieldset>                <div style="overflow: scroll;height: 300px">                    <table class="layui-table">                        <thead>                        <tr>                            <th>药名</th>                            <th>用量</th>                            <th>单位</th>                            <th>价格</th>                            <th>操作</th>                        </tr>                        </thead>                        <tbody>                        <template v-for="(item,index) in rxdrug_list" >                            <tr>                                <td>{{item.drugName}}</td>                                <td><input v-model="item.drugNumber"  autocomplete="off" name="drugNumber"  oninput="app.clearNoNum(this)"  placeholder="请输入用量" class="layui-input" lay-verify="" /></td>                                <td>{{item.drugUnit}}</td>                                <td v-if="item.upprice" style="color: #FF0000">{{item.upprice}}</td>                                <td v-else >{{item.drugPrice}}</td>                                <td><button type="button" v-on:click="delClick(index,item.id) " class="layui-btn layui-btn-danger layui-btn-xs">删除</button></td>                            </tr>                        </template>                        </tbody>                    </table>                </div>                <div style="margin-left: 5%;font-size: 16px;">                    <input class="layui-hide" name="drugMoney" v-model="allprice" />                    合计：【<span class="content"> 消费总金额：<i class="drugMoney" style="color: #FF0000" v-if="rxdrug_list.length>0">{{getTotal}}</i><i class="drugMoney" style="color: #FF0000" v-else>0.00 </i> </span>】                </div>                <!--<div class="layui-form-item">                    <label class="layui-form-label">检查照片</label>                    <div class="layui-input-block">                         <button type="button" class="layui-btn layui-btn-sm" id="pictureUpload"><i class="layui-icon"></i>选择图片</button>                         <div class="layui-upload-list">                             <template v-if="pictureList.length>0">                                 <template v-for="(item,index) in pictureList">                                     <div style="display: inline-block;">                                         <img :src="item.filePath" @click="app.previewImg" width="92px" height="92px" style="margin-right: 10px;"><br/><br/>                                         <button type="button" @click="app.deleteImg(index,pictureList)" style="margin-left: 25px"  class="layui-btn layui-btn-danger layui-btn-xs">删除</button>                                     </div>                                 </template>                             </template>                             <input type="hidden" name="picture" v-model="app.isNotEmpty(pictureList)?getpictureIds:''">                        </div>                    </div>                </div>-->                <div class="layui-input-block">                    <button type="button" class="layui-btn" lay-filter="recordForm" lay-submit>提交</button>                    <button type="button" class="layui-btn layui-btn-primary" @click="back">返回</button>                </div>            </form>        </div>    </div></div><script>    var vm = new Vue({        el: '#app',        data: {            msg: 'Hello World!',            info:{},            pictureList:[],            userdata:'',            rxdrugdata:[],            rxdrug_list:[],            treeList:'',            tempList:'',            treecheck:'',//判断选择的处方或处方模板            search:'',            cfmbList: [],            rxdrug:'',//判断是否有此药            cfmb:'',//判断药方模板中是否有此药            allprice:0,//总价格            view:app.getUrlParam("view"),            dictList:[],            select:'',        },        watch:{            //药方搜索            search:function (newVal,oldVal) {                var searchText = newVal;                if(app.isEmpty(searchText)){                    vm.treeList = vm.tempList;                }else {                    var list = vm.tempList;                    var arr = new Array();                    var reg = new RegExp(searchText);                    for(var i=0;i<list.length;i++){                        var item = list[i];                        if(app.isNotEmpty(item)){                            //如果字符串中不包含目标字符会返回-1                            if(vm.treecheck == 0 ){                                if((item.drugName).match(reg)){                                    arr.push(item);                                }                            }else if(vm.treecheck == 1){                                if((item.recipeName).match(reg)){                                    arr.push(item);                                }                            }else{                            }                        }                    }                    vm.treeList = arr;                }            },        },        computed:{            getpictureIds:function(){                var fileIds = '';                var list = vm.pictureList;                if(app.isNotEmpty(list)){                    for(let img of list){                        fileIds += img.fileId+",";                    }                    fileIds = fileIds.slice(0,fileIds.length-1);                }                return fileIds;            },            //获取总价格            getTotal:function () {                var total =  0                var list = vm.rxdrug_list;                for(let item of list){                    if(item.upprice){                        item.drugPrice=item.upprice                    }                    if(app.isEmpty(item.drugPrice) || app.isEmpty(item.drugNumber)){                        return ;                    }else {                        var price = app.accMul(item.drugNumber, item.drugPrice);                        total = app.accAdd(price, total)                    }                }                vm.adddrug=list                vm.allprice = total                return total;            },        },        methods: {            getDetail:async function(id){                vm.info = await request.fetch("getRecordDetail",{id:id});                form.val('recordForm', vm.info);                if(app.isNotEmpty(vm.info.picture)){                    vm.pictureList = await api.getFileList(vm.info.picture);                }            },            getrxdrug:async function(id){                vm.rxdrug_list = await request.fetch("/admin/rxdrug/getRxdrugList",{recordId:id});            },            getdoctorName:async function(){                vm.userdata = await request.fetch("/admin/user/getallUserList");            },            getTree:async  function(url,num){                vm.treecheck = num                vm.treeList = await request.fetch(url);                vm.tempList = vm.treeList;            },            //行点击            addRight:async function(item){                if(vm.treecheck == 0){                    if( app.isEmpty(item.drugPrice) ){                        alert("该药品暂无价格！")                        return ;                    }                    for(let rxdrug of vm.rxdrug_list){                        if(rxdrug.drugName == item.drugName){                            layer.confirm("【"+item.drugName+"】已经在药方中，更新处方中此药物的信息吗", {                                btn: ['确定', '取消'] //可以无限个按钮                            }, function(index){                                if(app.isNotEmpty(item.upprice)){                                    rxdrug.drugPrice=item.upprice                                }else{                                    rxdrug.drugPrice=item.drugPrice                                }                                rxdrug.drugUnit=item.drugUnit                                layer.close(index)                                //按钮【按钮一】的回调                            }, function(index){                                //按钮【按钮二】的回调                            });                            return ;                        }                    }                    vm.rxdrug_list.push(item);                }else if(vm.treecheck == 1){                    var list =  await request.post("/admin/cfnr/getrecipeId",{recipeId:item.id})                    for(let i of list){                        i.drugNumber = i.drugMass;                    }                    vm.cfmbList =list;                    for(let cfmb of  vm.cfmbList){                        for(let right of vm.rxdrug_list){                            if(cfmb.drugName == right.drugName){                                alert("【"+cfmb.drugName+"】已经在处方中")                                return ;                            }                        }                        vm.rxdrug_list.push(cfmb);                    }                }else{                    alert("添加失败")                }            },            backpatient:function(){            },            back:function(){                if(app.isNotEmpty(vm.view)&&vm.view=='patient'){                    location.href = '/admin/patient/patient_list';                }else{                    location.href = 'record_list'                }            },            getDic:async function(){                var data = {                }                var res = await api.getDictList(data);            },            //删除处方药            delClick(index,id){                if(app.isNotEmpty(id)){                    request.fetch("/admin/rxdrug/delRxdrug",{id:id}).then(res=>{                        vm.rxdrug_list.splice(index,1);                    })                }else{                    vm.rxdrug_list.splice(index,1);                }            },            getDict:async function(){                var id ="e83f192c870f5e6c26bd75318c322d19"                vm.dictList = await  request.post("/weixin/getDictList",{"drugTypeId":id})                //vm.dictList = request.post("/weixin/getDictList",{"drugTypeId":id})                console.log(vm.dictList)            },            getSelect:async function(){                request.fetch("/admin/patient/getPatientList",).then(res=>{                    for (let item of res){                        if(app.isEmpty(item.patientName)){                            item.patientName = item.phoneNumber                        }                    }                    vm.select = res;                })            },            addPatient:function(){                layer.open({                    type: 1,                    title:'新增患者',                    area: '500px',                    content: $('#addPPP'),                    anim: 0                    ,btn: ['返回']                    ,yes: function(index, layero){                        //按钮【按钮一】的回调                        layer.close(index);                    }                });            },            setId:function(name){                vm.getSelect();                var sId = ''                console.log("name:"+name)                for (let item of vm.select){                    console.log("item.patientName"+item.patientName)                    if(item.patientName==name){                        sId = item.id                        console.log("进来了")                    }                }                console.log('sid'+sId)            },            selectTis:function(){                $('#hc_select').next().find("dd").on('mouseenter', function(d){                    if(app.isNotEmpty($(this).attr('lay-value').split(',')[0])){                        var phone = $(this).attr('lay-value').split(',')[1];                        var sex = $(this).attr('lay-value').split(',')[2];                        var age = $(this).attr('lay-value').split(',')[3];                        layer.tips(phone+' '+(sex==1?'男':sex==2?'女':'')+' '+(age!=''?age+'岁':''), this ,{                            time:3000                        }); //在元素的事件回调体中，follow直接赋予this即可                    }                });            },        },        mounted:async function() {            vm = this;            var id = app.getUrlParam('id');            await vm.getDict();            await  vm.getdoctorName();            await vm.getTree("/admin/drug/getallDrug",0);            await vm.getSelect()            laydate.render({                elem: '#checkTime',                type: "datetime",                value: new Date(),            });            upload.render({                elem: '#pictureUpload',                url: '/admin/common/upload',                accept: 'images',                data: {                    fileSavePath:""                },                done: function(res, index, upload){ //上传后的回调                    app.success("上传成功");                    var fileId = res.data.fileId;                    var filePath = res.data.filePath;                    vm.pictureList.push(res.data);                }            });            app.isNotEmpty(id) && await vm.getDetail(id);            app.isNotEmpty(id) &&  await vm.getrxdrug(id);            form.on('submit(recordForm)', function (data) {                var rxdata = vm.rxdrug_list;                data.field.rxdata = JSON.stringify(rxdata);                request.post("/admin/record/editRecord",data.field).then(res=>{                    //提交处方数据                    if(app.isNotEmpty(vm.view)&&vm.view=='patient'){                        //location.href = '/admin/patient/patient_list'                    }else{                        location.href = 'drug?id='+res.id                    }                })                return false;            });            $("#is_pay_explain").hover(function () {                var tips = layer.tips('加价价格显示红色；<br />否则为原价', '#is_pay_explain',{                    tips: [1, '#555555']                    // 上右下左四个方向，通过1-4进行方向设定                });                sleep(5000);                layer.close(tips);            })            form.on('submit(patientForm)', function (data) {                request.post("/admin/patient/editPatient",data.field).then(res=>{                    app.success("操作成功！");                    layer.closeAll();                    $("#HandoverCompany").val(res.patientName);                    $("#patientId").val(res.id)                    vm.getSelect()                    form.reload()                })                return false;            });            form.render();        },        updated: function () {            form.render();            vm.selectTis()        }    })</script><script>    layui.use(['form', 'layedit','upload'], function () {        // $("#HandoverCompany").on('mouseenter',function(){        //     console.log("------------"+data.value)        //     layer.tips('1', this ,{        //         time:1000        //     }); //在元素的事件回调体中，follow直接赋予this即可        // })        var form = layui.form        form.on('select(hc_select)', function (data) {   // 赋值给input框            $("#HandoverCompany").val(data.value.split(',')[0]);            $("#hc_select").next().find("dl").css({ "display": "none" });            //console.log(data.elem[data.elem.selectedIndex].id)            $("#patientId").val(data.elem[data.elem.selectedIndex].id)            form.render();            vm.selectTis()            // $('.layui-anim-upbit dd').on('mouseenter', function(d){            //     var phone = $(this).attr('lay-value').split(',')[1];            //     var sex = $(this).attr('lay-value').split(',')[2];            //     var age = $(this).attr('lay-value').split(',')[3];            //     layer.tips(phone+' '+(sex==1?'男':sex==2?'女':'')+' '+(age!=''?age+'岁':''), this ,{            //         time:3000            //     }); //在元素的事件回调体中，follow直接赋予this即可            // });        });        window.searchSelect = function () {            var value = $("#HandoverCompany").val();            $("#hc_select").val(value);            form.render();            $("#hc_select").next().find("dl").css({ "display": "block" });            var dl = $("#hc_select").next().find("dl").children();            var j = -1;            for (var i = 0; i < dl.length; i++) {                if (dl[i].innerHTML.indexOf(value) <= -1) {                    dl[i].style.display = "none";                    j++;                }                if (j == dl.length-1) {                    $("#hc_select").next().find("dl").css({ "display": "none" });                }            }            vm.selectTis()            form.close()        }    });</script><style>    .drugMoney{        font-weight: bold;    }    .selectRed{        background: #444;        color: #eee;    }</style><% } %>