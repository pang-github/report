<% layout("/common/_container.html"){ %><div class="layui-fluid" id="app">    <div class="layui-row layui-col-space15 ">            <div class="layui-col-sm12 layui-col-md3 layui-col-lg2"  style="min-height: 10px;">                <div class="layui-card">                    <div class="layui-card-body mini-bar">                        <fieldset class="layui-elem-field layui-field-title">                            <legend style="color:#009688;font-size: 16px;">患者</legend>                        </fieldset>                        <div class="layui-input-inline">                            <input type="text" placeholder="名字搜索" style="width: 200px;" class="layui-input" v-model="patientSearch" >                        </div>                        <div class="layui-tab-content" >                            <div style="height: 600px;overflow: scroll;">                                <div id="tree"></div>                                <!--<div v-for="(item,index) in treeData" v-on:click="search(item)">                                    {{item.patientName}}                                </div>-->                            </div>                        </div>                    </div>                </div>            </div>            <div class="layui-col-sm12 layui-col-md9 layui-col-lg10" style="background: #FFFFFF;">                <div class="layui-card">                    <div class="layui-card-body">                <div class="layui-form toolbar">                    <div class="layui-form-item">                        <div class="layui-inline">                            <input v-model="condition" class="layui-input" type="text" placeholder="名称"/>                        </div>                        <div class="layui-inline">                            <button type="button" @click="tableReload" class="layui-btn icon-btn"><i class="layui-icon">&#xe615;</i>搜索</button>                            <button type="button" @click="tableReload('reset')" class="layui-btn icon-btn" ><i class="layui-icon">&#xe669;</i>重置</button>                            <button type="button" @click="btnAdd" class="layui-btn icon-btn"><i class="layui-icon">&#xe654;</i>添加</button>                            <button type="button" @click="btnPrint" id="btnPrint" class="layui-btn layui-btn-danger icon-btn"><i class="layui-icon layui-icon-print"></i>打印病例</button>                        </div>                    </div>                </div>                <table class="layui-table" id="recordTable" lay-filter="recordTable"></table>                    </div>                </div>            </div>    </div></div><script type="text/html" id="tableBar">    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">修改</a>    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a></script><script type="text/html" id="titleTipl">    <a href="javascript:;" data-d="{{d.descript}}" οnmοuseοver="show_shopm(this)">{{d.name}}</a></script><script type="text/html" id="titleTpl">    <select name="interest" class="sel_scrq" lay-filter="aihao" style="height: 10px">        <option value="1" selected="">{{d.stateTypeName}}</option>    </select></script><script>    var initColumn =  [[        {type: 'radio'},        {field:'id',title:'',hide:true},        {field: 'stateType', title: '病历状态'},        {field:'checkTime',title:'检查时间'},        {field:'patientName',title:'患者名字'},        {field:'patientId',title:'患者id',hide:true},        {field:'examine',title:'检查',width:200},        {field:'diagnose',title:'诊断',width:200},        {field:'drugList',title:'药品详情',templet:function(d){               //'<span style="color: #c00;">'+ itme.drugName +'</span>:'+ itme.drugNumber+itme.drugUnit +'<br>'                var html = "";                var i = 0                for(let item of d.drugList){                    i++                    if(i==5){                        i=0                        html += ('<span style="color: #c00;">'+item.drugName+"</span>:"+item.drugNumber+item.drugUnit+"<br>");                    }else{                        html += ('<span style="color: #c00;">'+item.drugName+"</span>:"+item.drugNumber+item.drugUnit);                    }                }                return html;            }},        {field:'drugMoney',title:'药品总价格'},        {field:'picture',title:'检查照片',hide: true},        {field:'zycs',title:'就诊次数'},        {align: 'center', toolbar: '#tableBar', title: '操作'}    ]];    var vm = new Vue({        el: '#app',        data: {            msg: 'Hello World!',            condition:'',            treeData:'',            treename:[],            patient:{},            patientPID:"",            patientPNAME:"",            patientSearch:"",            newtree:'',            sessionPID:'',            DictList:{},        },        watch:{            patientSearch:function (newVal,oldVal) {                var list = new Array();                for(let item of vm.treename){                        if((item.title).match(newVal)){                            var data = {                                id:item.id,                                title:item.title,                                name:item.name,                            }                            list.push(data)                        }                    }                vm.newtree = list                tree.reload('demoId', {                    data: [{                        title: '患者' //一级菜单                        ,spread: true                        ,children: vm.newtree //二级菜单                    }]                    ,click:function(obj){                        vm.patient=obj.data;                        vm.search(obj)                    }                });                $('.layui-tree-txt span').on('mouseenter', function(d){                    var phone = $(this).attr('data-d');                    var sex = $(this).attr('data-sex');                    layer.tips(phone+(sex==1? ' 男 ':' 女 '), this ,{                        time:1000                    }); //在元素的事件回调体中，follow直接赋予this即可                });                },        },        methods: {            getTree:async function(){                var url = '/admin/patient/getPatientList'                /*if(!app.isEmpty(vm.tree.id)){                    url += '?patientId='+vm.tree.id                }*/                vm.treeData = await request.fetch(url);                var temp = vm.treeData;                var list = new Array();                for(let item of temp){                    var age = '';                    var data = {                        id:item.id,                        title:"<span data-d="+item.phoneNumber+','+item.patientSex+" >"+item.patientName+"</span>",                        name:item.patientName                    }                    if(app.isEmpty(item.patientName)){                        var data = {                            id:item.id,                            title:'<span data-d='+item.phoneNumber+','+item.patientSex+' style="color:#5FB878">'+item.phoneNumber+'</span>',                            name:item.phoneNumber                        }                    }                    list.push(data)                }                vm.treename = list            },            search:async function(obj){                var queryData = {                    patientId:obj.data.id,                };                table.reload('recordTable',{                    where: queryData, page: {                        curr: 1 //重新从第 1 页开始                    }});            },            btnAdd:function () {                var patient  = vm.patient;                var id = vm.patientPID;                if(app.isNotEmpty(patient.id)){                    location.href = 'record_edit?patientId='+patient.id+'&patientName='+patient.name;                }else{                    location.href = 'record_edit?patientId='+vm.patientPID+'&patientName='+vm.patientPNAME;                }            },            btnPrint:function(){                //打开打印页面                    var  checkStatus= table.checkStatus("recordTable");                    var item = checkStatus.data                    if(!app.isEmpty(item)){                        var src = '/admin/record/record_print?id=' + item[0].id+"&patientId="+item[0].patientId;                        // window.location.href = src;                        parent.layer.open({                            type: 2 //Page层类型                            ,title: '病例打印'                            ,area:['700px', '900px']                            ,shadeClose: true                            ,shade: 0.5 //遮罩透明度                            ,maxmin: true //允许全屏最小化                            ,content:src                            ,btn: ['打印', '取消']                            ,btnAlign: 'c'                            ,success: function(layero, index){                            }                            ,yes: function(index, layero){                                var pageIndex = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引                                //得到iframe页的窗口对象                                var iframeWin = $(layero).find("iframe")[0].contentWindow;                                iframeWin.printA4();                                //按钮【按钮一】的回调                            }                            ,btn2: function(index, layero){                                //按钮【按钮二】的回调                                //return false 开启该代码可禁止点击该按钮关闭                            }                        });                        //app.printFun(src);                    }else{                        app.error("请先选择需要打印的订单╮(╯▽╰)╭");                    }            },            tableReload:function (action) {                if(action=='reset'){ vm.condition='' };                var queryData = {                    //id:vm.condition,                    patientName:vm.condition,                    //checkTime:vm.condition,                    //patientId:vm.condition,                };                table.reload('recordTable',{                    where: queryData, page: {                        curr: 1 //重新从第 1 页开始                    }});            },            csstree:function(){                $('div [data-id="'+vm.patientPID+'"] div [class=layui-tree-txt]').css({'background-color':'#4f5655',"color":'#FFFFFF'});            },            treecss:function(){                $('div [data-id="' + vm.patientPID + '"] div [class=layui-tree-txt]').css({                    'background-color': '#FFFFFF',                    "color": '#555'                });            }        },        mounted: async function () {            vm = this;            //elem.find('.layui-tree-txt').html()            if (app.isNotEmpty(sessionStorage.getItem('PID'))) {                var PID = sessionStorage.getItem('PID').split(',')                vm.patientPID = PID[0]                vm.patientPNAME = PID[1]            }            await this.getTree();            var tree = layui.tree;            //渲染            tree.render({                elem: '#tree'  //绑定元素                , id: 'demoId'                , data: [{                    title: '患者' //一级菜单                    , spread: true                    , children: vm.treename //二级菜单                }]                , click: function (obj) {                    vm.patient = obj.data;                    vm.search(obj)                    /* 先恢复原来颜色 */                    vm.treecss()                    vm.patientPID = obj.data.id                    /* 改变点击的颜色 */                    vm.csstree()                }            });            if (app.isNotEmpty(vm.patientPID)) {                var queryData = {                    patientId: vm.patientPID,                };                var obj={                    data:{                        id: vm.patientPID,                        title: vm.patientPNAME,                        name: vm.patientPNAME                    }                }                vm.patient = obj.data;                table.render({                    elem: '#recordTable',                    url: 'getRecordList',                    page: true,                    height: "full-132",                    cellMinWidth: 100,                    where: queryData,                    cols: initColumn,                    done: function () {                        sessionStorage.setItem("PID",'');                    }                });            }else{                table.render({                    elem: '#recordTable',                    url: 'getRecordList',                    page: true,                    height: "full-132",                    cellMinWidth: 100,                    cols: initColumn,                    done: function () {                        // /* 防止下拉框的下拉列表被隐藏---必须设置--- */                        // $(".sel_scrq").parent().css('overflow', 'visible');                    }                });            }            table.on('tool(recordTable)', function (obj) {                var event = obj.event;                var data = obj.data;                if (event == 'del') {                    app.confirm("确定删除吗?", function () {                        request.fetch("delRecord", {id: data.id}).then(res => {                            app.success("删除成功！")                            vm.tableReload();                        })                    })                } else if (event == 'edit') {                    location.href = 'record_edit?id=' + data.id;                }            });            /* 跳转改变患者树的颜色*/            vm.csstree()            $('.layui-tree-txt span').on('mouseenter', function(d){                var phone = $(this).attr('data-d').split(',')[0];                var sex = $(this).attr('data-d').split(',')[1];                layer.tips(phone+' '+(sex==1?'男':sex==2?'女':''), this ,{                    time:1000                }); //在元素的事件回调体中，follow直接赋予this即可            });        },        updated: function () {        }    })</script><style>    /* 使得下拉框与单元格刚好合适 */    td .layui-form-select{        margin-top: -10px;        margin-left: -15px;        margin-right: -15px;    }</style><% } %>