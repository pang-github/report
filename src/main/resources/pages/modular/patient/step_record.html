<% layout("/common/_container.html"){ %><div class="layui-fluid" id="app">    <div class="layui-card" >        <div class="layui-col-md3 layui-col-sm12"  style="min-height: 10px;">            <div id="fiexdDiv" >                <div style="display: block; box-sizing:border-box;width:95%;padding: 35px;background: #FFFFFF;" >                    <blockquote class="layui-elem-quote">处方选择</blockquote>                    <div id="template" style="margin-top: 20px;">                        <div class="layui-form-item">                            <label class="layui-form-label" style="width: 40px !important;">  搜索:</label>                            <div class="layui-input-inline">                                <input type="text" placeholder="名字搜索" style="width: 200px;" class="layui-input"  v-model="search">                            </div>                        </div>                        <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">                            <ul class="layui-tab-title">                                <li class="layui-this" v-on:click="getTree('/admin/drug/getallDrug','0')">处方药</li>                                <li v-on:click="getTree('/admin/cfmb/getCfmbList','1')">处方模板</li>                            </ul>                            <div class="layui-tab-content" >                                <div style="height: 600px;overflow: scroll;">                                    <table class="layui-table"  >                                        <thead v-if="treecheck == 0">                                        <tr>                                            <th>药名</th>                                            <th>单位</th>                                            <th>价格(元)</th>                                        </tr>                                        </thead>                                        <thead v-if="treecheck == 1">                                        <tr>                                            <th>处方名</th>                                            <th>价格(元)</th>                                        </tr>                                        </thead>                                        <tbody >                                        <tr v-for="(item,index) in treeList" v-if="treecheck == 0"  v-on:click="addRight(item)">                                            <td>{{item.drugName}}</td>                                            <td>{{item.drugUnit}}</td>                                            <td>{{item.drugPrice}}</td>                                        </tr>                                        <tr v-for="(item,index) in treeList" v-if="treecheck == 1"  v-on:click="addRight(item)">                                            <td >{{item.recipeName}}</td>                                            <td >{{item.recipePrice}}</td>                                        </tr>                                        </tbody>                                    </table>                                </div>                            </div>                        </div>                    </div>                </div>            </div>        </div>        <div class="layui-col-md9 layui-col-sm10" style="background: #FFFFFF;">            <form class="layui-form" lay-filter="recordForm" style="max-width: 1000px;margin: 40px auto;">                <input type="hidden" name="id">                <input id="patientId" name="patientId"  value="${parameter.patientId}" type="text" placeholder="请输入患者id" class="layui-input layui-hide" lay-verify="" />                <table class="layui-table">                    <tbody>                    <tr>                        <td>患者名字</td>                        <td>                            <input id="patientName" autocomplete="off" name="patientName" value="${parameter.patientName}" type="text" placeholder="请输入患者名字" class="layui-input" lay-verify="" />                        </td>                        <td>就诊次数</td>                        <td>                            <input name="zycs" type="text" placeholder="请输入就诊次数"  oninput="app.clearNoNum(this)" class="layui-input" lay-verify="" />                        </td>                    </tr>                    <tr>                        <td>检查时间</td>                        <td>                            <input id="checkTime" name="checkTime" type="text" placeholder="请输入检查时间" class="layui-input" lay-verify="" />                        </td>                        <td>检查医生<span style="color: red;">*</span></td>                        <td>                            <select name="checkDoctor" lay-search  lay-verify="required">                                <option></option>                                <option v-for="item in userdata" :value="item.realName">{{item.realName}}</option>                            </select>                        </td>                    </tr>                    <tr>                        <td >检查</td>                        <td colspan="3">                            <textarea name="examine" type="text" placeholder="请输入检查" class="layui-textarea" lay-verify="" ></textarea>                        </td>                    </tr>                    <tr>                        <td >诊断</td>                        <td colspan="3">                            <textarea name="diagnose" type="text" placeholder="请输入诊断" class="layui-textarea" lay-verify="" ></textarea>                        </td>                    </tr>                    </tbody>                </table>                <fieldset class="layui-elem-field layui-field-title site-title">                    <legend>                        <a name="default">处方</a>                    </legend>                </fieldset>                <div style="overflow: scroll;height: 300px">                    <table class="layui-table">                        <thead>                        <tr>                            <th>药名</th>                            <th>用量</th>                            <th>单位</th>                            <th>价格</th>                            <th>操作</th>                        </tr>                        </thead>                        <tbody>                        <template v-for="(item,index) in rxdrug_list" >                            <tr>                                <td>{{item.drugName}}</td>                                <td><input v-model="item.drugNumber"  autocomplete="off" name="drugNumber"  oninput="app.clearNoNum(this)"  placeholder="请输入用量" class="layui-input" lay-verify="" /></td>                                <td>{{item.drugUnit}}</td>                                <td >{{item.drugPrice}}</td>                                <td><button type="button" v-on:click="delClick(index,item.id) " class="layui-btn layui-btn-danger layui-btn-xs">删除</button></td>                            </tr>                        </template>                        </tbody>                    </table>                </div>                <div style="margin-left: 5%;font-size: 16px;">                    <input class="layui-hide" name="drugMoney" v-model="allprice" />                    合计：【<span class="content"> 消费总金额：<i class="drugMoney" style="color: #FF0000" v-if="rxdrug_list.length>0">{{getTotal}}</i><i class="drugMoney" style="color: #FF0000" v-else>0.00 </i> </span>】                </div>                <!--<div class="layui-form-item">                    <label class="layui-form-label">检查照片</label>                    <div class="layui-input-block">                         <button type="button" class="layui-btn layui-btn-sm" id="pictureUpload"><i class="layui-icon"></i>选择图片</button>                         <div class="layui-upload-list">                             <template v-if="pictureList.length>0">                                 <template v-for="(item,index) in pictureList">                                     <div style="display: inline-block;">                                         <img :src="item.filePath" @click="app.previewImg" width="92px" height="92px" style="margin-right: 10px;"><br/><br/>                                         <button type="button" @click="app.deleteImg(index,pictureList)" style="margin-left: 25px"  class="layui-btn layui-btn-danger layui-btn-xs">删除</button>                                     </div>                                 </template>                             </template>                             <input type="hidden" name="picture" v-model="app.isNotEmpty(pictureList)?getpictureIds:''">                        </div>                    </div>                </div>-->                <div class="layui-input-block" style="margin-top: 20px;">                    <button type="button" class="layui-btn" @click="last">上一步</button>                    <button type="button" class="layui-btn" lay-filter="recordForm" lay-submit>下一步</button>                </div>            </form>        </div>    </div></div><script>    var vm = new Vue({        el: '#app',        data: {            msg: 'Hello World!',            info:{},            pictureList:[],            userdata:'',            rxdrugdata:[],            rxdrug_list:[],            treeList:'',            tempList:'',            treecheck:'',//判断选择的处方或处方模板            search:'',            cfmbList: [],            rxdrug:'',//判断是否有此药            cfmb:'',//判断药方模板中是否有此药            allprice:0,//总价格            view:app.getUrlParam("view")        },        watch:{            //药方搜索            search:function (newVal,oldVal) {                var searchText = newVal;                if(app.isEmpty(searchText)){                    vm.treeList = vm.tempList;                }else {                    var list = vm.tempList;                    var arr = new Array();                    var reg = new RegExp(searchText);                    for(var i=0;i<list.length;i++){                        var item = list[i];                        if(app.isNotEmpty(item)){                            //如果字符串中不包含目标字符会返回-1                            if(vm.treecheck == 0 ){                                if((item.drugName).match(reg)){                                    arr.push(item);                                }                            }else if(vm.treecheck == 1){                                if((item.recipeName).match(reg)){                                    arr.push(item);                                }                            }else{                            }                        }                    }                    vm.treeList = arr;                }            },        },        computed:{            getpictureIds:function(){                var fileIds = '';                var list = vm.pictureList;                if(app.isNotEmpty(list)){                    for(let img of list){                        fileIds += img.fileId+",";                    }                    fileIds = fileIds.slice(0,fileIds.length-1);                }                return fileIds;            },            //获取总价格            getTotal:function () {                var total =  0                var list = vm.rxdrug_list;                for(let item of list){                    if(app.isEmpty(item.drugPrice) || app.isEmpty(item.drugNumber)){                        return ;                    }else {                        var price = app.accMul(item.drugNumber, item.drugPrice);                        total = app.accAdd(price, total)                    }                }                vm.allprice = total                return total;            },        },        methods: {            getDetail:async function(id){                vm.info = await request.fetch("getRecordDetail",{id:id});                form.val('recordForm', vm.info);                if(app.isNotEmpty(vm.info.picture)){                    vm.pictureList = await api.getFileList(vm.info.picture);                }            },            getrxdrug:async function(id){                vm.rxdrug_list = await request.fetch("/admin/rxdrug/getRxdrugList",{recordId:id});            },            getdoctorName:async function(){                vm.userdata = await request.fetch("/admin/user/getallUserList");            },            getTree:async  function(url,num){                vm.treecheck = num                vm.treeList = await request.fetch(url);                vm.tempList = vm.treeList;            },            //行点击            addRight:async function(item){                if(vm.treecheck == 0){                    if( app.isEmpty(item.drugPrice) ){                        alert("该药品暂无价格！")                        return ;                    }                    for(let rxdrug of vm.rxdrug_list){                        if(rxdrug.drugName == item.drugName){                            alert("【"+item.drugName+"】已经在处方中")                            return ;                        }                    }                    vm.rxdrug_list.push(item);                }else if(vm.treecheck == 1){                    vm.cfmbList =  await request.post("/admin/cfnr/getrecipeId",{recipeId:item.id})                    for(let cfmb of  vm.cfmbList){                        for(let right of vm.rxdrug_list){                            if(cfmb.drugName == right.drugName){                                alert("【"+cfmb.drugName+"】已经在处方中")                                return ;                            }                        }                        vm.rxdrug_list.push(cfmb);                    }                }else{                    alert("添加失败")                }            },            backpatient:function(){            },            back:function(){                if(app.isNotEmpty(vm.view)&&vm.view=='patient'){                    location.href = '/admin/patient/patient_list';                }else{                    location.href = 'record_list'                }            },            getDic:async function(){                var data = {                }                var res = await api.getDictList(data);            },            //删除处方药            delClick(index,id){                if(app.isNotEmpty(id)){                    request.fetch("/admin/rxdrug/delRxdrug",{id:id}).then(res=>{                        vm.rxdrug_list.splice(index,1);                    })                }else{                    vm.rxdrug_list.splice(index,1);                }            },            last:function () {                window.parent.vm.last();            }        },        mounted:async function() {            vm = this;            var id = app.getUrlParam('id');            await vm.getDic();            await  vm.getdoctorName();            await vm.getTree("/admin/drug/getallDrug",0);            laydate.render({                elem: '#checkTime',                type: "datetime",                value: new Date(),            });            upload.render({                elem: '#pictureUpload',                url: '/admin/common/upload',                accept: 'images',                data: {                    fileSavePath:""                },                done: function(res, index, upload){ //上传后的回调                    app.success("上传成功");                    var fileId = res.data.fileId;                    var filePath = res.data.filePath;                    vm.pictureList.push(res.data);                }            });            app.isNotEmpty(id) && await vm.getDetail(id);            app.isNotEmpty(id) &&  await vm.getrxdrug(id);            form.on('submit(recordForm)', function (data) {                var rxdata = vm.rxdrug_list;                data.field.rxdata = JSON.stringify(rxdata);                request.post("/admin/record/editRecord",data.field).then(res=>{                    window.parent.vm.step2Sub(res.id);                })                return false;            });            form.render();        },        updated: function () {            form.render();        }    })</script><script>    layui.use(['tableSelect'], function () {        var tableSelect = layui.tableSelect;        //患者名称        tableSelect.render({            elem: '#patientName',	//定义输入框input对象            checkedKey: 'id',//表格的唯一建值，非常重要，影响到选中状态 必填            searchKey: 'patientName',	//搜索输入框的name值 默认keyword            searchPlaceholder: '关键词搜索',	//搜索输入框的提示文字 默认关键词搜索            table: {	//定义表格参数，与LAYUI的TABLE模块一致，只是无需再定义表格elem                url: '/admin/patient/getPatientList',                cols: [[                    {type: 'radio'},                    {field: 'id', title: 'ID', hide: true,},                    {field: 'patientName', title: '姓名',},                    {field: 'patientAge', title: '年龄'},                ]]            },            done: function (elem, data) {                //选择完后的回调，包含2个返回值 elem:返回之前input对象；data:表格返回的选中的数据 []                //拿到data[]后 就按照业务需求做想做的事情啦~比如加个隐藏域放ID...                elem.val(data.data[0].patientName)                $("#patientId").val(data.data[0].id)            }        })    })</script><style>    .drugMoney{        font-weight: bold;    }</style><% } %>