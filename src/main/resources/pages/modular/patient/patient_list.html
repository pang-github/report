<% layout("/common/_container.html"){ %><div class="layui-fluid" id="app">    <div class="layui-col-md12">        <div class="layui-card">            <div class="layui-card-body">                <div class="layui-form toolbar">                    <div class="layui-form-item">                        <div class="layui-inline">                            <input v-model="condition" class="layui-input" type="text" placeholder="名称"/>                        </div>                        <div class="layui-inline">                            <button type="button" @click="tableReload" class="layui-btn icon-btn"><i class="layui-icon">&#xe615;</i>搜索</button>                            <button type="button" @click="tableReload('reset')" class="layui-btn icon-btn" ><i class="layui-icon">&#xe669;</i>重置</button>                            <button type="button" @click="btnAdd" class="layui-btn icon-btn"><i class="layui-icon">&#xe654;</i>添加</button>                            <button type="button" @click="btnAddbl" class="layui-btn layui-btn-danger icon-btn"><i class="layui-icon">&#xe654;</i>添加病历</button>                        </div>                    </div>                </div>                <table class="layui-table" id="patientTable" lay-filter="patientTable"></table>            </div>        </div>    </div></div><script type="text/html" id="tableBar">    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">修改</a></script><script type="text/html" id="tableBar1">    <a class="layui-btn layui-btn-xs" lay-event="priview">查看</a></script><script>    //跳转患者历史病例页面    function getInfo(id) {        top.layui.index.closeTab("/admin/record/record_list");        top.layui.index.openTab({            title: '病历列表',            url: "/admin/record/record_list",            end: function() {            }        });        sessionStorage.setItem("PID",id);    }    var initColumn = [[        {type: 'radio'},        {title: '详情', width: 60, icon: ['layui-icon layui-icon-triangle-r', 'layui-icon layui-icon-triangle-d'],  children:[                {                    title: '患者病例'                    ,url: function(row){                        return '/admin/record/getRecordList?patientId='+row.id                    }                    ,height: 300                    ,page: false                    ,cols: [[                        {type: 'radio'},                        {field: 'id', hide: true, title: 'ID'},                        {field: 'patientId', hide: true, title: '患者ID'},                        {field: 'zycs',edit: 'text', title: '就诊次数(可编辑)',width:150},                        {field: 'checkTime',title: '住院时间'},                        {field: 'patientName',title: '患者名字'},                        {field: 'examine',title: '检查',},                        {field: 'diagnose',title: '诊断',},                        {field: '',title: '处方',templet(d){                                var html = "";                                for(let item of d.drugList){                                    html += (item.drugName+":"+item.drugNumber+item.drugUnit);                                }                                return html;                            }},                    ]],                    editEvent: function(obj, pobj) {//子表单元格编辑                        // obj 子表当前行对象                        // pobj 父表当前行对象                        var id = obj.data.id;                        //layer.msg(obj.oldValue + " 已成功改为：" + obj.value);                        request.post("/admin/record/editupdate",{id:id,zycs:obj.value,}).then(res=>{                            app.success("更新成功！");                            //location.href = 'patient_list'                        })                    },                    done : function(res, curr, count) {                        console.log(res.msg)                        if (res.count == 0) {                            $(".layui-none").text('暂无历史病例');                        }                    }                }, {                    title: '随访记录'                    ,url: function(row){                        return '/admin/taskdetail/getTaskdetailList?patientId='+row.id                    }                    ,height: 300                    ,page: true                    ,cols: [[                        {type: 'radio'},                        {field:'id',title:'',hide:true},                        {field:'taskId',title:'任务id',hide:true},                        {field:'taskName',title:'任务名'},                        {field:'patientName',title:'患者姓名'},                        {field:'patientId',title:'患者id',hide:true},                        {field:'content',title:'随访内容',hide:true},                        {field:'result',title:'随访结果',hide:true},                        {field:'createTime',title:'开始时间'},                        {field:'modifyTime',title:'修改时间'},                    ]],                    done : function(res, curr, count) {                        console.log(res.msg)                    },                    rowEvent: function (obj, pobj) {                        // obj 子表当前行对象                        // 可从中调用 event/data/tr/update/del                        // this.id 通过 this 对象获取当前子表的id                        // pobj 父表当前行数据                        // 可从pobj中调用                        //    data/tr/update/del/close                        console.log(obj)                        var data = obj.data;                            if(app.isNotEmpty(data.result)){                            // ,anim: -1                            //         ,title: false                            //         ,closeBtn: false                            //         ,offset: 'r'                            //         ,shade: 0.1                            //         ,shadeClose: true                            //         ,skin: 'layui-anim layui-anim-rl layui-layer-adminRight'                            //         ,area: '300px'                                top.layui.admin.open({                                    type: 2,                                    title: '随访结果',                                    content: '/admin/patient/followResult',                                    area: '800px',                                    anim: -1,                                    offset:'rb',                                    shadeClose:true,                                    closeBtn:false,                                    shade: 0.1,                                    skin: 'layui-anim layui-anim-rl layui-layer-adminRight',                                    success:function ( layero,index) {                                        var iframeWin = $(layero).find("iframe")[0].contentWindow;                                        iframeWin.vm.tplList = JSON.parse(data.result);                                    }                                });                            }else{                                app.error("该随访未完成")                            }                        }                }            ]},        {field: 'id', hide: true, title: 'ID'},        {field: 'patientName',title: '姓名',templet:function (d) {                return '<a style="text-decoration:underline;color:#1E9FFF"  onclick="getInfo(\''+ d.id +','+d.patientName+'\');">'+d.patientName+'</a>';            }},        {field: 'patientTypeName',title: '患者分类',},        {field: 'phoneNumber',title: '手机号',width:120},        {field: 'patientSex',title: '性别',width:60,templet(d) {                if(d.patientSex==1){                    return '男'                } else if(d.patientSex==2){                    return '女'                }else{                     return '';                }            }},        {field: 'patientAge',title: '年龄',width:60,},        {field: 'patientSource',title:'注册来源',},        {field: 'patientNickname',title:'微信昵称',},        {field: 'patientProfession',title: '职业',},        {field: 'patientOrigo',title: '籍贯',width:150},        {field: 'patientNation',title: '民族',hide: true,},        {field: 'workUnit',title: '工作单位',width:200},        {field: 'address',title: '住址',width: 350,},        {field: 'admissionTime',title: '入院时间',sort: true,hide: true,},        {field: 'blcjz',title: '病例采集者',hide: true,},        {field: 'marriage',title: '婚姻',hide: true,},        {field: 'complaint',title: '备注',hide: true,},        /*{field: 'xbs',title: '现病史',hide: true,},*/        {fixed: 'right',align: 'center', toolbar: '#tableBar', title: '操作', width:120}    ]];    var vm = new Vue({        el: '#app',        data: {            msg: 'Hello World!',            condition:''        },        methods: {            btnAdd:function () {                location.href = 'step';            },            btnAddbl:function () {                var checkRows = table.checkStatus("patientTable");                var data = checkRows.data;                var dataString = JSON.stringify(data);                var dataMap = JSON.parse(dataString);                if (checkRows.data.length === 0) {                    app.error("请选择要添加病历的患者");                } else {                    var id = dataMap[0].id;                    var name = dataMap[0].patientName;                    location.href = '/admin/record/record_edit?patientId='+id+'&patientName='+name+'&view=patient';                }            },            tableReload:function (action) {                if(action=='reset'){ vm.condition='' };                var queryData = {                    patientName:vm.condition,                };                table.reload('patientTable',{                    where: queryData, page: {                        curr: 1 //重新从第 1 页开始                    }});            }        },        mounted:async function() {            vm = this;            layui.use(['tableChild'], function () {                var tableChild = layui.tableChild;            table.render({                elem: '#patientTable',                url: 'getPatientList',                page: true,                height: "full-106",                cellMinWidth: 100,                cols: initColumn,                done:function (data) {                    tableChild.render(this);                    $("[data-field='patientSource']").children().each(function () {                        if ($(this).text() == '0') {                            $(this).text("后台")                        }else if ($(this).text() == '1') {                            $(this).text("微信")                        }                    });                }            });            });            table.on('tool(patientTable)', function (obj) {                var event = obj.event;                var data = obj.data;                if (event == 'del') {                    app.confirm("确定删除吗?",function () {                        request.fetch("delPatient",data).then(res=>{                            app.success("删除成功！")                            vm.tableReload();                        })                    })                } else if (event == 'edit') {                    location.href = 'patient_edit?id='+data.id;                }            });            form.render();        },        updated: function () {            form.render();        }    })</script><style></style><% } %>