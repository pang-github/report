<div class="lay-header" >    <span class="layui-breadcrumb" lay-separator="/">      <a href="${ctxPath}${parameter.url}">${parameter.title}</a>      <a href="#"><cite>处方管理</cite></a>    </span></div><% layout("/common/_container.html"){ %><script type="text/javascript" src="/modular/cfmb/cfmb.js"></script><div class="layui-fluid" id="app" style="margin-top: 40px;">    <div class="layui-card" >        <div class="layui-col-md3 layui-col-sm12"  style="min-height: 10px;">            <div id="fiexdDiv" >                <div style="display: block; box-sizing:border-box;width:95%;padding: 35px;background: #FFFFFF;" >                    <blockquote class="layui-elem-quote">药品选择</blockquote>                    <div id="template" style="margin-top: 20px;">                        <div class="layui-form-item">                            <label class="layui-form-label" style="width: 40px !important;">  搜索:</label>                            <div class="layui-input-inline">                                <input type="text" placeholder="名字搜索" style="width: 200px;" class="layui-input"  v-model="search">                            </div>                        </div>                        <div class="layui-tab layui-tab-brief">                            <ul class="layui-tab-title">                                <li class="layui-this">处方药</li>                            </ul>                            <div class="layui-tab-content" >                                <div style="height: 560px;overflow: scroll;">                                    <table class="layui-table"  >                                        <thead >                                        <tr>                                            <th>药名</th>                                            <th>单位</th>                                            <th id="is_pay_explain" >价格(元)<i class="layui-icon layui-icon-about" style="font-size: 18px; color: #555555;"></i>  </th>                                        </tr>                                        </thead>                                        <tbody >                                        <tr v-for="(item,index) in drugList"  v-on:click="addright(item)">                                            <td>{{item.drugName}}</td>                                            <td>{{item.drugUnit}}</td>                                            <td v-if="item.upprice" style="color: #FF0000"   >{{item.upprice}}</td>                                            <td v-else >{{item.drugPrice}}</td>                                        </tr>                                        </tbody>                                    </table>                                </div>                            </div>                        </div>                    </div>                </div>            </div>        </div>        <div class="layui-col-md9 layui-col-sm10" style="background: #FFFFFF;">            <form class="layui-form" lay-filter="cfmbForm" style="margin: 35px 0 30px 20%;">                    <input type="hidden" name="id">                <div class="layui-form-item">                    <label class="layui-form-label" style="text-align: left">处方名</label>                    <div class="layui-input-block">                        <input id="recipeName" name="recipeName" placeholder="请输入处方名" type="text" class="layui-input" lay-verify="" />                    </div>                </div>                <div style="overflow: scroll;height: 600px">                    <table class="layui-table">                        <tr>                            <blockquote class="layui-elem-quote" style="text-align: left;">                                处方药物                            </blockquote>                        </tr>                        <thead>                        <tr>                            <th>药物名称</th>                            <th>药物用量</th>                            <th>药物单位</th>                            <th>药物价格</th>                            <th>操作</th>                        </tr>                        </thead>                        <tbody >                        <template v-for="(item,index) in adddrug" >                            <tr >                                <td>{{ item.drugName }}</td>                                <td>                                    <input class="layui-input" name="drugMass" v-model="item.drugMass">                                </td>                                <td>{{ item.drugUnit }}</td>                                <td v-if="item.upprice" style="color: #FF0000">{{item.upprice}}</td>                                <td v-else >{{item.drugPrice}}</td>                                <td><button type="button" v-on:click="delClick(index,item.id) " class="layui-btn layui-btn-danger layui-btn-xs">删除</button></td>                            </tr>                        </template>                        </tbody>                    </table>                </div>                <div hidden  v-if="adddrug.length>0">{{getTotal}}</div>                <input class="layui-hide" id="recipePrice" name="recipePrice" v-model="allmoney">                    <div class="layui-form-item" style="margin:28px 30px;">                        <div class="layui-input-block">                            <button type="button"  class="layui-btn" lay-filter="cfmbForm" lay-submit>提交</button>                            <button type="button" class="layui-btn layui-btn-primary" @click="back">返回</button>                        </div>                    </div>            </form>        </div>    </div></div><script>    var vm = new Vue({        el: '#app',        data: {            msg: 'Hello World!',            info:"",            num:1,            drugList:'',            tempList:'',            search:'',            allmoney:'',            adddrug:[],        },        watch:{            //药方搜索            search:function (newVal,oldVal) {                var searchText = newVal;                if(app.isEmpty(searchText)){                    vm.drugList = vm.tempList;                }else {                    var list = vm.tempList;                    var arr = new Array();                    var reg = new RegExp(searchText);                    for(var i=0;i<list.length;i++){                        var item = list[i];                        if(app.isNotEmpty(item)){                            //如果字符串中不包含目标字符会返回-1                                if((item.drugName).match(reg)){                                    arr.push(item);                                }                        }                    }                    vm.drugList = arr;                }            },        },        computed:{            //获取总价格            getTotal:function () {                var total =  0                var list = vm.adddrug;                for(let item of list){                    if(item.upprice){                        item.drugPrice=item.upprice                    }                    if(app.isEmpty(item.drugPrice) || app.isEmpty(item.drugMass)){                        return ;                    }else {                        var price = app.accMul(item.drugMass, item.drugPrice);                        total = app.accAdd(price, total)                    }                }                vm.adddrug=list                vm.allmoney = total                return total;            },        },        methods: {            getDetail:async function(id){                vm.info = await request.fetch("getCfmbDetail",{id:id});                vm.info.recipePrice =vm.allmoney                form.val('cfmbForm', vm.info);            },            getcfnrItem:async function(id){                vm.adddrug =   await request.fetch("/admin/cfnr/getrecipeId",{recipeId:id});            },            back:function(){                location.href = 'cfmb_list';            },            getdrugList:async  function(){                vm.drugList = await request.fetch("/admin/drug/getallDrug");                vm.tempList = vm.drugList;            },            addright: async function (obj) {                if( app.isEmpty(obj.drugPrice) ){                    alert("该药品暂无价格！")                    return ;                }                for(let rightList of vm.adddrug){                    if(obj.drugName == rightList.drugName ){                        layer.confirm("【"+obj.drugName+"】已经在药方中，再次添加更新价格", {                            btn: ['确定', '取消'] //可以无限个按钮                        }, function(index){                            if(app.isNotEmpty(obj.upprice)){                                rightList.drugPrice=obj.upprice                            }else{                                rightList.drugPrice=obj.drugPrice                            }                            rightList.drugUnit=obj.drugUnit                            layer.close(index)                            //按钮【按钮一】的回调                        }, function(index){                            //按钮【按钮二】的回调                        });                        return ;                    }                }                vm.adddrug.push(obj)            },            //删除处方药            delClick(index,id){                if(app.isNotEmpty(id)){                    request.fetch("/admin/cfnr/delCfnr",{id:id}).then(res=>{                        vm.adddrug.splice(index,1);                    })                }else{                    vm.adddrug.splice(index,1);                }            },            alertMsg:function(){            }        },        mounted:async function() {            vm = this;            var id = app.getUrlParam('id');            await vm.getdrugList();            await vm.getcfnrItem(id);            app.isNotEmpty(id) && await vm.getDetail(id) && await vm.getcfnrItem(id);;            form.on('submit(cfmbForm)', function (data) {                var rxdata = vm.adddrug                data.field.rxdata = JSON.stringify(rxdata)                request.post("addCfmb",data.field).then(res=>{                        app.success("操作成功！");                        location.href = 'cfmb_list'                })                return false;            });            form.render();            $("#is_pay_explain").hover(function () {                var tips = layer.tips('加价价格显示红色；<br />否则为原价', '#is_pay_explain',{                    tips: [1, '#555555']                    // 上右下左四个方向，通过1-4进行方向设定                });                sleep(5000);                layer.close(tips);            })        },        updated: function () {            form.render();        }    })</script><% } %>