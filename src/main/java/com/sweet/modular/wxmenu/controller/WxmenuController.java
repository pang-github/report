package com.sweet.modular.wxmenu.controller;import cn.hutool.json.JSONUtil;import com.alibaba.fastjson.JSON;import com.alibaba.fastjson.JSONArray;import com.alibaba.fastjson.JSONObject;import com.sweet.core.model.ResultBean;import com.sweet.core.model.system.LayuiPageInfo;import com.sweet.modular.wxmenu.entity.Wxmenu;import com.sweet.modular.wxmenu.service.WxmenuService;import com.sweet.wxmp.WxMpProperties;import me.chanjar.weixin.common.error.WxErrorException;import me.chanjar.weixin.mp.api.WxMpService;import me.chanjar.weixin.mp.bean.material.WxMpMaterialNewsBatchGetResult;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.core.env.Environment;import org.springframework.stereotype.Controller;import org.springframework.transaction.annotation.Transactional;import org.springframework.web.bind.annotation.RequestBody;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.ResponseBody;import javax.annotation.PostConstruct;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;/** * <p> * 微信菜单 前端控制器 * </p> * * @author admin * @since 2020-01-08 */@Controller@RequestMapping("/admin/wxmenu")public class WxmenuController {    @Autowired    WxmenuService wxmenuService;    @Autowired    WxMpService wxService;    @Autowired    WxMpProperties properties;    String appId;    @PostConstruct    public void loadData(){        appId = properties.getConfigs().get(0).getAppId();    }    @RequestMapping("")    public String index(){        return "/modular/wxmenu/index";    }    /**     * 列表页     */    @RequestMapping("/wxmenu_list")    public String list(){        return "/modular/wxmenu/wxmenu_list";    }    /**     * 编辑页     */    @RequestMapping("/wxmenu_edit")    public String edit(){        return "/modular/wxmenu/wxmenu_edit";    }    /**     * 添加/编辑     */    @RequestMapping("/editWxmenu")    @ResponseBody    public ResultBean editWxmenu(@RequestBody Wxmenu wxmenu){        if ((wxmenu.getTier().intValue() == 1)) {            wxmenu.setParentId(appId);        }else{            wxmenu.setParentId(appId+","+wxmenu.getParentId());        }        wxmenuService.saveOrUpdate(wxmenu);        return ResultBean.success(wxmenu);    }    /**     * 删除     */    @RequestMapping("/delWxmenu")    @ResponseBody    @Transactional    public ResultBean delWxmenu(Wxmenu wxmenu){        if(wxmenu.getTier()==1){            wxmenuService.delButtonsById(wxmenu.getButtonId());        }        wxmenuService.removeById(wxmenu);        return ResultBean.success(wxmenu);    }    /**     * 添加修改菜单     * @param menu     * @return     */    @RequestMapping("/getWxmenuDetail")    @ResponseBody    public ResultBean getWxmenuDetail(String buttonId){        String appid = properties.getConfigs().get(0).getAppId();        List<Wxmenu> list = wxmenuService.getMenuByAppId(appid);        return ResultBean.success(list);    }    @RequestMapping("/saveButton")    @ResponseBody    @Transactional    public ResultBean saveButton(@RequestBody List<Wxmenu> wxmenuList){        wxmenuService.saveButton(wxmenuList);        return ResultBean.success(wxmenuList);    }    @RequestMapping("/updateMenu")    @ResponseBody    @Transactional    public ResultBean updateMenu(String list,String menu) throws WxErrorException {        List<Wxmenu> wxmenuList =  JSON.parseArray(list, Wxmenu.class);        wxmenuService.saveButton(wxmenuList);        Map map = new HashMap<>();        map.put("button",wxmenuList);        String str = JSONUtil.toJsonStr(map);        str = str.replaceAll("\"text\",","\"click\",");        str = str.replaceAll("\"mediaId\":","\"media_id\":");        wxService.getMenuService().menuCreate(str);        return ResultBean.success();    }    /**     * 列表数据     */    @RequestMapping("/getWxmenuList")    @ResponseBody    public LayuiPageInfo getWxmenuList(Wxmenu Wxmenu){        LayuiPageInfo pageInfo = wxmenuService.findPageBySpec(Wxmenu);        return pageInfo;    }    @RequestMapping("/getWxResource")    @ResponseBody    public ResultBean getWxResource() throws WxErrorException {        WxMpMaterialNewsBatchGetResult result = wxService.getMaterialService().materialNewsBatchGet(0,20);        return ResultBean.success(result);    }}